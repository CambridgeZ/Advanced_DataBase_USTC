# 简介

在本项目中，我们将实现一个简单的存储和缓冲管理器。文档描述了缓冲区和帧的大小、存储结构、页面格式、文件格式、缓冲和哈希技术、文件存储结构以及磁盘空间和缓冲模块的接口函数。本项目中所采用的技术是从课堂中与缓冲和存储管理器相关的材料中选择的。

## 缓冲区与帧

### 缓冲区与帧大小

缓冲区指的是主内存中的空间，CPU只能访问位于主内存中的内容。缓冲区由帧数组组成。当需要访问某一页面时，该页面会被加载到缓冲区内存中。大多数商业数据库管理系统会将帧的大小设置为与页面大小相同，以防止外部碎片。在本项目中，我们也采用相同的策略。项目中默认的缓冲区大小为1024。

### 缓冲区与帧的存储结构

缓冲区由逻辑分区组成，称为帧。帧会存储在全局定义的结构中，描述了帧的结构。定义如下：
```c
#define FRAMESIZE 4096

struct bFrame {
    char field[FRAMESIZE];
};
```
缓冲区数组将存储一系列的帧，用于存放加载的页面。定义如下：
```c
#define DEFBUFSIZE 1024
bFrame buf[DEFBUFSIZE];  // 或者由用户通过输入参数定义的大小
```
缓冲区管理器、文件和访问方法将通过该缓冲区引用所需的页面。

## 页面格式

在本项目中，我们无需参考页面的详细结构，唯一重要的信息是page_id和page_size，因此不需要设计页面格式。

## 文件格式

我们建议使用基于目录的结构来组织数据库文件。每个文件都有一个基本页面，其中包含指向文件中每个页面的指针。基本页面按顺序存放每个页面的指针。数据页面仅包含记录，无需指针。要查找文件中的下一页，需要查阅基本页面。

基于目录的文件格式便于快速查找特定的页面。它允许我们快速访问所需页面，而无需在长列表中搜索。

## 缓冲技术

我们选择使用最近最少使用（LRU）作为实验中的唯一替换策略。LRU算法通过LRU队列来组织缓冲页面，并按上次引用时间排序。它总是选择LRU位置的页面作为替换页面。LRU算法的主要优势在于其常数时间复杂度，且在具有高时间局部性（即当前引用页面在不久的将来有很高的再次引用概率）的访问模式下表现良好。

## 哈希技术

对于缓冲区中的每一帧，需要维护一个缓冲控制块（BCB）。每个缓冲控制块包含page_id、frame_id、page_latch、fix_count和dirty_bit。page_id用作哈希函数的键，将其映射到一个BCB。我们需要维护两个哈希表：一个用于将page_id映射到frame_id和BCB，另一个用于将frame_id映射到page_id。

我们建议使用简单的静态哈希技术。在静态哈希中，桶的数量是固定的。如果某个桶已满，则会为额外的数据条目连接一个溢出链。哈希函数使用键值将其映射到桶中，并在桶内进行顺序搜索。随着时间的推移，桶的数量不会改变。

## 文件存储

在本项目中，我们仅需要一个物理文件存储在磁盘中。数据库中的所有数据都将保存在该文件中。该文件位于工作目录中，命名为data.dbf。即使文件为空，它也应始终存在，因为在系统首次运行时，它将为空。

## 类设计

### 数据存储管理器（DSMgr）

DSMgr类负责文件操作。其主要接口函数包括：

	•	OpenFile(string filename)：打开指定文件。
	•	CloseFile()：关闭当前使用的文件。
	•	ReadPage(int page_id)：读取指定页面。
	•	WritePage(int frame_id, bFrame frm)：写入页面数据。
	•	Seek(int offset, int pos)：移动文件指针。
	•	GetFile()：获取当前文件。
	•	IncNumPages()：增加页面计数。
	•	GetNumPages()：获取页面计数。
	•	SetUse(int page_id, int use_bit)：设置页面的使用位。
	•	GetUse(int page_id)：获取页面的使用位。

### 缓冲管理器（BMgr）

BMgr类负责缓冲区的页面管理。主要接口函数包括：

	•	FixPage(int page_id, int prot)：查找页面是否已在缓冲区中，若不存在则加载页面。
	•	FixNewPage()：为新页面分配缓冲区。
	•	UnfixPage(int page_id)：解除页面固定状态。
	•	NumFreeFrames()：获取空闲缓冲帧数量。
	•	SelectVictim()：选择替换页面。
	•	Hash(int page_id)：通过page_id获取frame_id。
	•	RemoveBCB(BCB* ptr, int page_id)：移除缓冲控制块。
	•	RemoveLRUEle(int frid)：移除LRU列表中的元素。
	•	SetDirty(int frame_id)：设置脏位。
	•	UnsetDirty(int frame_id)：清除脏位。
	•	WriteDirtys()：写出所有脏页面。
	•	PrintFrame(int frame_id)：打印帧内容。

## 实验设置

在本项目中，需要进行基于Zipf分布的跟踪实验以演示实验结果。该实验包含500,000次页面引用，页面编号范围为1至50,000。实验开始时缓冲区为空，所有涉及的页面需先在磁盘中生成对应的数据文件data.dbf。

## 实施计划

该计划概述了如何实现和集成文件与访问方法、缓冲管理器以及磁盘空间管理器的接口功能。以下是每个接口函数的详细说明：

+ 文件与访问方法（File & Access Methods）
  + 将调用缓冲区接口函数以管理页面的加载、替换和存储。
  + 函数包括：
    + FixPage(int page_id, int prot): 固定指定页面ID的页面，设置保护级别。
    + FixNewPage(): 创建并固定一个新页面。
    + UnfixPage(int page_id): 解除页面的固定状态。
    + NumFreeFrames(): 获取当前空闲的缓冲帧数量。
    + SelectVictim(): 选择一个页面作为替换的候选。
    + Hash(int page_id): 根据页面ID生成对应的缓冲区帧。
    + RemoveBCB(BCB* ptr, int page_id): 从缓冲控制块列表中移除指定的页面ID。
    + RemoveLRUEle(int frid): 从LRU列表中移除指定帧ID的元素。
    + SetDirty(int frame_id): 将指定帧的脏位设为1。
    + UnsetDirty(int frame_id): 将指定帧的脏位设为0。
    + WriteDirtys(): 将所有脏页面写入磁盘。
    + PrintFrame(int frame_id): 打印指定帧的内容，用于调试或输出查看。
+ 磁盘空间管理器（Disk Space Manager）
    + 该模块主要负责对物理文件data.dbf进行操作，包括打开、关闭、读取和写入页面。
    + 接口函数包括：
      + OpenFile(string filename): 打开指定的数据库文件。
      +	CloseFile(): 关闭当前正在使用的数据库文件。
      +	ReadPage(int page_id): 读取指定页面ID的数据。
      +	WritePage(int frame_id, bFrame frm): 将缓冲区帧的数据写入指定页面ID。
      +	Seek(int offset, int pos): 将文件指针移动到指定位置。
      +	GetFile(): 返回当前打开的文件指针。
      +	IncNumPages(): 增加页面数量计数器，用于记录新分配的页面。
      +	GetNumPages(): 获取当前总页面数。
      +	SetUse(int page_id, int use_bit): 设置页面的使用标记，以跟踪页面的使用状态。
      +	GetUse(int page_id): 获取指定页面的使用标记。
+ 缓冲区（主存）
  +	缓冲区的实现细节未详细列出，因为本项目仅处理缓冲管理器和存储管理器的实现。

## 实验步骤与说明

在该实验中，我们将执行一项基于跟踪的实验，以展示缓冲管理器和存储管理器的工作性能。实验过程包含以下步骤：

1. 实验初始化
	+ 在实验开始前，缓冲区应为空。
	+ 需要预先生成并将实验所需的50,000个页面全部存储在磁盘文件data.dbf中。
2. 跟踪记录处理
	+ 实验中的跟踪记录根据Zipf分布生成。共有500,000次页面引用，页面编号在1到50,000之间。
	+ 每条跟踪记录的格式为“x, ###”，其中x为操作类型（0表示读取，1表示写入），###为引用的页面编号。
	+ 程序需扫描跟踪文件并统计内存与磁盘之间的总I/O操作次数。
3. 运行实验
	+ 逐步执行跟踪记录中的操作，调用缓冲管理器和存储管理器接口处理页面的加载、读取、写入、替换等操作。
	+ 记录和输出缓冲区与磁盘之间的I/O总次数。
4. 结果分析
   + 通过跟踪记录生成的统计数据，我们可以分析缓冲管理器的性能，并评估页面替换策略的效果。

以上内容是该文档的详细翻译和解释。该文档提供了设计和实现数据库缓冲区管理器和存储管理器的详细指导，包括如何组织数据存储、管理页面缓冲区、选择页面替换策略以及实现实验测试的过程和分析方法。这些内容适用于数据库管理系统课程中的相关实验项目。